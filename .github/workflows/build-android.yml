name: Android Client Build

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  build_android_apk:
    # Use a standard Linux runner
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Workflow Repository
        # This step is standard, but we don't strictly need it if the workflow is only cloning another repo. 
        # Keeping it for standard structure.
        uses: actions/checkout@v4

      - name: Checkout Target Repository (GalaxyBudsClient)
        # Clones the target repository into a local directory named 'GalaxyBudsClient'
        uses: actions/checkout@v4
        with:
          repository: timschneeb/GalaxyBudsClient
          ref: master # Assuming you want the master branch
          path: GalaxyBudsClient
      
      - name: Setup .NET SDK 8.x
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'

      - name: Install .NET Android Workload
        # The 'net8.0-android' target framework requires the Android workload to be installed.
        run: dotnet workload install android
      
      - name: Restore Dependencies
        # Restore dependencies for the entire solution/project.
        run: dotnet restore GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj

      - name: Publish Android APK (Release)
        # We use 'publish' to compile and package the application.
        # -c Release: Build in Release mode.
        # -f net8.0-android: Target the specific framework.
        # --runtime android-arm64: Target the 64-bit ARM architecture (most common).
        # -p:NoDemo=true: Based on your .csproj, this defines the ApplicationId for the full version.
        run: |
          dotnet publish GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj \
            -c Release \
            -f net8.0-android \
            --runtime android-arm64 \
            -p:NoDemo=true \
            --self-contained true

      - name: Find Generated APK File
        # The publish command outputs the APK to a nested 'bin' directory. We find the file for upload.
        id: find_apk
        run: |
          APK_FILE=$(find GalaxyBudsClient/GalaxyBudsClient.Android/bin/Release -name "*.apk" | head -n 1)
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        # Makes the built APK available for download on the GitHub Actions summary page.
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-Android-APK
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 7
