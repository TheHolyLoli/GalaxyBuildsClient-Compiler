name: Build GalaxyBudsClient Android

on:
  workflow_dispatch:   # allows manual run
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout this workflowâ€™s repository (if needed)
      - name: Checkout self
        uses: actions/checkout@v4

      # 2. Clone the external GalaxyBudsClient repo
      - name: Clone GalaxyBudsClient repo
        run: |
          git clone https://github.com/timschneeb/GalaxyBudsClient.git external-GalaxyBudsClient
          cd external-GalaxyBudsClient
          git checkout master   # or another branch/tag if needed
        working-directory: .

      - name: Patch Android API level for Avalonia
        run: |
          cd external-GalaxyBudsClient/GalaxyBudsClient.Android
          sed -i 's/<TargetFrameworkVersion>v14.0<\/TargetFrameworkVersion>/<TargetFrameworkVersion>v34.0<\/TargetFrameworkVersion>/' GalaxyBudsClient.Android.csproj
          sed -i 's/<SupportedOSPlatformVersion>24<\/SupportedOSPlatformVersion>/<SupportedOSPlatformVersion>34<\/SupportedOSPlatformVersion>/' GalaxyBudsClient.Android.csproj

      - name: Show patched csproj
        run: cat external-GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj



      # 3. Setup .NET SDK
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'  # adjust based on project requirement
        continue-on-error: true

      # 4. Install Android workload
      - name: Install Android workload
        run: |
          dotnet workload install android
        continue-on-error: true

      # 5. Restore dependencies
      - name: Restore dependencies
        run: |
          cd external-GalaxyBudsClient
          dotnet restore GalaxyBudsClient.sln
        continue-on-error: true

      # 6. Build the Android target
      - name: Build Android
        run: |
          cd external-GalaxyBudsClient
          dotnet build GalaxyBudsClient.sln \
            -c Release \
            -f net8.0-android \
            -p:TargetFrameworkVersion=v34.0 \
            -p:SupportedOSPlatformVersion=34
        continue-on-error: true
      # 7. (Optional) Archive the output
      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-Android
          path: |
            external-GalaxyBudsClient/**/bin/Release/net8.0-android/**/*.apk   # adjust path/extension if needed
