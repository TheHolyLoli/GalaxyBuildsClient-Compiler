name: Android Client Build

on:
  workflow_dispatch:

jobs:
  build_android_apk:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: timschneeb/GalaxyBudsClient
          ref: master
          path: GalaxyBudsClient
      
      - name: Patch Project File (Run BEFORE Setup)
        # We patch the file immediately after checkout to ensure all subsequent dotnet commands see the correct version.
        # 1. Force API 34 (net8.0-android -> net8.0-android34.0)
        # 2. Remove RuntimeIdentifiers entirely to prevent restoration for x86/x64.
        # 3. Remove TargetFrameworkVersion to avoid conflicts with the TFM.
        run: |
          PROJECT_PATH="GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj"
          
          echo "--- Content Before Patch ---"
          grep -E "TargetFramework|RuntimeIdentifiers" $PROJECT_PATH || echo "Tags not found via grep"

          # 1. Replace generic TFM with specific API 34 TFM
          sed -i 's/net8.0-android/net8.0-android34.0/g' $PROJECT_PATH
          
          # 2. Delete the RuntimeIdentifiers line completely. 
          # This prevents the build system from trying to validate the package against x86/x64.
          sed -i '/<RuntimeIdentifiers>/d' $PROJECT_PATH
          
          # 3. Delete legacy version tag
          sed -i '/<TargetFrameworkVersion>/d' $PROJECT_PATH
          
          echo "--- Content After Patch ---"
          grep -E "TargetFramework|RuntimeIdentifiers" $PROJECT_PATH || echo "Tags not found via grep"

      - name: Setup Java 17
        # Required for Android API 34
        uses: actions/setup-java@v4
        with:
          distribution: 'microsoft'
          java-version: '17'
      
      - name: Setup .NET SDK 8.x
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.x'
      - name: Install .NET Android Workload (with API 34)
        run: |
          dotnet workload install android --include-previews
          dotnet workload install android-platform --include-previews
          dotnet workload install android-emulator --include-previews

      
      - name: Restore Dependencies
        # We explicitly restore for the ARM64 runtime to match our target.
        # Since the project file is patched, -p:TargetFramework should be redundant but is kept for safety.
        run: |
          dotnet restore GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj \
            -r android-arm64 \
            -p:TargetFramework=net8.0-android34.0

      - name: Publish Android APK (Release)
        run: |
          dotnet publish GalaxyBudsClient/GalaxyBudsClient.Android/GalaxyBudsClient.Android.csproj \
            -c Release \
            -f net8.0-android34.0 \
            -r android-arm64 \
            -p:NoDemo=true \
            --self-contained true

      - name: Find Generated APK File
        id: find_apk
        run: |
          APK_FILE=$(find GalaxyBudsClient/GalaxyBudsClient.Android/bin/Release -name "*.apk" | head -n 1)
          echo "Found APK: $APK_FILE"
          echo "apk_path=$APK_FILE" >> $GITHUB_OUTPUT

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: GalaxyBudsClient-Android-APK
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 7
